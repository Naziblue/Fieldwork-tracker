<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fieldwork Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/customParseFormat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 
      SECURITY: This loads the secret key from a separate file 'secrets.js' if it exists.
      It handles the error gracefully if the file is missing (common in production).
    -->
    <script src="secrets.js"
        onerror="console.log('secrets.js not found (normal for production if using environment variables)')"></script>

    <script>
        // Custom color palette configuration for Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#6B7280', // Pastel Gray
                        text: '#E4E4E4',       // Light Gray
                        accent1: '#A8DADC',    // Light Cyan
                        accent2: '#FFC1CC',    // Soft Pink
                        'pastel-blue': '#ADD8E6', // Added new pastel blue
                        button: '#B39CD0',     // Lavender
                        'button-hover': '#a188c0' // darker lavender
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .modal,
        .settings-panel {
            transition: opacity 0.3s ease, transform 0.3s ease-in-out;
        }

        .view-btn {
            background-color: transparent;
            color: #B39CD0;
            border: 1px solid #B39CD0;
            transition: all 0.2s ease;
        }

        .view-btn:hover,
        .view-btn-active {
            background-color: #B39CD0;
            color: white;
        }

        /* Overrides for new theme */
        .bg-gray-800 {
            background-color: #4B5563;
        }

        .bg-gray-700 {
            background-color: #525c6b;
        }

        .text-text {
            color: #FFFFFF;
        }

        .text-gray-300 {
            color: #E5E7EB;
        }

        .border-gray-600 {
            border-color: #525c6b;
        }

        .bg-gray-600 {
            background-color: #4B5563;
        }

        .bg-gray-500 {
            background-color: #6B7280;
        }

        .section-header {
            color: #A8DADC;
            border-bottom: 1px solid #525c6b;
            padding-bottom: 0.5rem;
        }

        .summary-box {
            background-color: transparent;
            border: 1px solid #525c6b;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-background text-text antialiased">

    <!-- Login View -->
    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center max-w-md">
            <h1 class="text-4xl font-bold text-pastel-blue mb-2">Fieldwork Tracking</h1>
            <p class="text-gray-300 mb-8">Please sign in to access your fieldwork log.</p>
            <div class="flex flex-col gap-4">
                <button id="login-btn"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center mx-auto w-full">
                    Sign in with Google
                </button>
                <button id="guest-login-btn"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center mx-auto w-full">
                    Sign in as Guest
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-4">Guest login data is only saved in this browser. Clear your browser
                data and it will be lost. Sign in with Google to save your data permanently.</p>
            <div id="login-error-message" class="mt-4 text-red-400 text-sm bg-red-900/50 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-6 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-pastel-blue">Fieldwork Tracking</h1>
            <div class="absolute top-0 right-0 flex items-center gap-4">
                <div id="user-display" class="text-sm text-gray-300"></div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg"
                    title="Logout">
                    Log Out
                </button>
                <button id="settings-btn"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-2 rounded-lg" title="Settings">
                    Settings
                </button>
            </div>
        </header>

        <!-- View Navigation -->
        <nav class="flex justify-center gap-2 mb-8">
            <button class="view-btn px-4 py-2 rounded-lg font-medium" data-view="monthly">Monthly View</button>
            <button class="view-btn px-4 py-2 rounded-lg font-medium" data-view="yearly">Yearly View</button>
            <button class="view-btn px-4 py-2 rounded-lg font-medium" data-view="all-time">All Time View</button>
        </nav>

        <!-- VIEWS CONTAINER -->
        <main>
            <!-- MONTHLY VIEW -->
            <div id="monthly-view" class="view-container hidden">
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold section-header mb-4">Monthly Summary</h2>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0">
                            <label for="month-selector" class="text-sm font-medium text-gray-300">Select Month:</label>
                            <input type="month" id="month-selector"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg p-2">
                        </div>
                    </div>
                    <div id="monthly-summary-grid"
                        class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 text-center"></div>
                </section>
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold section-header mb-4">Log New Activity</h2>
                    <form id="tracker-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-start">
                        <!-- Inputs -->
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Date</label><input type="date"
                                id="date"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                required></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Start Time</label><input
                                type="time" id="start-time"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                required></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">End Time</label><input
                                type="time" id="end-time"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                required></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Setting</label><select
                                id="setting"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                                <option>School</option>
                                <option>Home</option>
                                <option>Clinic</option>
                                <option>Community</option>
                            </select></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Activity Type</label><select
                                id="activity-type"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                                <option>Restricted</option>
                                <option>Unrestricted</option>
                            </select></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Supervision Type</label><select
                                id="supervision-type"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                                <option>No Supervision</option>
                                <option>1:1 Meeting (with Supervisor)</option>
                                <option>Group Supervision</option>
                                <option>Observation with Client (by Supervisor)</option>
                            </select></div>

                        <div id="supervisor-name-wrapper"><label
                                class="block mb-2 text-sm font-medium text-gray-300">Overseeing
                                Supervisor</label><select id="supervisor-select"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                required>
                                <option value="">Select a supervisor...</option>
                            </select></div>
                        <div><label class="block mb-2 text-sm font-medium text-gray-300">Client Present?</label><select
                                id="client-present"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                                <option>No</option>
                                <option>Yes</option>
                            </select></div>
                        <div id="client-name-wrapper"><label class="block mb-2 text-sm font-medium text-gray-300">Client
                                Name / Student ID</label><input type="text" id="client-name"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                placeholder="e.g., Student A" required></div>

                        <!-- Conditional Unrestricted Activity Type -->
                        <div id="unrestricted-type-wrapper" class="hidden md:col-span-2">
                            <label class="block mb-2 text-sm font-medium text-gray-300">Unrestricted Activity</label>
                            <select id="unrestricted-type-select"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                                <option value="">Select Activity...</option>
                                <option>Observation</option>
                                <option>Training</option>
                                <option>Assessments</option>
                                <option>Graphing/Analysis</option>
                                <option>Research</option>
                                <option>Writing Programs/Reports</option>
                            </select>
                        </div>

                        <div id="unrestricted-wrapper" class="hidden md:col-span-2 lg:col-span-4">
                            <label class="block mb-2 text-sm font-medium text-gray-300">Unrestricted Explanation</label>
                            <textarea id="unrestricted-explanation" rows="2"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                placeholder="e.g., Parent training, data analysis..."></textarea>
                        </div>

                        <div class="md:col-span-2 lg:col-span-4 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-medium text-gray-300">Additional Notes (Required)</label>
                                <!-- AI Button Commented Out 
                                <button type="button" id="ai-generate-btn" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded flex items-center gap-1">
                                    <span>âœ¨ Auto-Generate Note</span>
                                </button>
                                -->
                            </div>
                            <textarea id="notes" rows="2"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                                placeholder="Explain the direct care and ABA strategies used..." required></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-4">
                            <button type="submit"
                                class="w-full text-white bg-button hover:bg-button-hover font-medium rounded-lg text-sm px-5 py-2.5 text-center">Add
                                Entry</button>
                        </div>
                    </form>
                </section>
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold section-header mb-4">Monthly Exports</h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="generate-mfvf-btn"
                            class="flex-1 w-full text-white bg-button hover:bg-button-hover font-medium rounded-lg text-sm px-5 py-2.5 text-center">Generate
                            M-FVF (PDF)</button>
                        <button id="export-monthly-csv-btn"
                            class="flex-1 w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Export
                            to Excel (.csv)</button>
                    </div>
                </section>
                <section class="p-6 bg-gray-600 rounded-2xl shadow-lg overflow-x-auto">
                    <h2 class="text-2xl font-semibold section-header mb-4">Monthly Log</h2>
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr id="monthly-table-header"></tr>
                        </thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </section>
            </div>

            <!-- YEARLY VIEW -->
            <div id="yearly-view" class="view-container hidden">
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold section-header mb-4">Yearly Summary</h2>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0">
                            <label for="year-selector" class="text-sm font-medium text-gray-300">Select Year:</label>
                            <input type="number" id="year-selector"
                                class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg p-2 w-28">
                        </div>
                    </div>
                    <div id="yearly-summary-grid"
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
                </section>
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold section-header mb-4">Yearly Export</h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="export-yearly-pdf-btn"
                            class="flex-1 w-full text-white bg-teal-600 hover:bg-teal-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Export
                            Yearly Report (PDF)</button>
                        <button id="export-yearly-csv-btn"
                            class="flex-1 w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Export
                            to Excel (.csv)</button>
                    </div>
                </section>
                <section class="p-6 bg-gray-600 rounded-2xl shadow-lg overflow-x-auto">
                    <h2 class="text-2xl font-semibold section-header mb-4">Yearly Log</h2>
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr id="yearly-table-header"></tr>
                        </thead>
                        <tbody id="yearly-log-table-body"></tbody>
                    </table>
                </section>
            </div>

            <!-- ALL TIME VIEW -->
            <div id="all-time-view" class="view-container hidden">
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold section-header mb-4">All Time Summary</h2>
                    <div id="all-time-summary-grid"
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
                </section>
                <section class="mb-8 p-6 bg-gray-600 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold section-header mb-4">All Time Export</h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="export-all-time-pdf-btn"
                            class="flex-1 w-full text-white bg-teal-600 hover:bg-teal-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Export
                            Full History (PDF)</button>
                        <button id="export-all-time-csv-btn"
                            class="flex-1 w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Export
                            to Excel (.csv)</button>
                    </div>
                </section>
                <section class="p-6 bg-gray-600 rounded-2xl shadow-lg overflow-x-auto">
                    <h2 class="text-2xl font-semibold section-header mb-4">Cumulative Progress</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-text mb-2 text-center">Total Hours (Goal: 1500)</h3>
                            <canvas id="totalHoursChart"></canvas>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-text mb-2 text-center">Unrestricted Hours (Goal: 900)
                            </h3>
                            <canvas id="unrestrictedHoursChart"></canvas>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-text mb-2 text-center">Restricted Hours (Goal: 600)</h3>
                            <canvas id="restrictedHoursChart"></canvas>
                        </div>
                    </div>
                </section>
                <section class="mt-8 p-6 bg-gray-600 rounded-2xl shadow-lg overflow-x-auto">
                    <h2 class="text-2xl font-semibold section-header mb-4">Complete Log</h2>
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr id="all-time-table-header"></tr>
                        </thead>
                        <tbody id="all-time-log-table-body"></tbody>
                    </table>
                </section>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-4 z-50 hidden opacity-0 overflow-y-auto">
        <div
            class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-2xl p-6 transform transition-transform duration-300 scale-95 my-auto">
            <h2 class="text-2xl font-semibold text-text mb-6">Edit Activity</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Inputs -->
                    <div><label class="block mb-2 text-sm">Date</label><input type="date" id="edit-date"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5"></div>
                    <div><label class="block mb-2 text-sm">Start Time</label><input type="time" id="edit-start-time"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5"></div>
                    <div><label class="block mb-2 text-sm">End Time</label><input type="time" id="edit-end-time"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5"></div>
                    <div>
                        <label for="edit-setting" class="block mb-2 text-sm font-medium text-gray-300">Setting</label>
                        <select id="edit-setting"
                            class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                            <option>School</option>
                            <option>Home</option>
                            <option>Clinic</option>
                            <option>Community</option>
                        </select>
                    </div>
                    <div><label for="edit-activity-type" class="block mb-2 text-sm">Activity Type</label><select
                            id="edit-activity-type"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5">
                            <option>Restricted</option>
                            <option>Unrestricted</option>
                        </select></div>
                    <div><label for="edit-supervision-type" class="block mb-2 text-sm">Supervision Type</label><select
                            id="edit-supervision-type"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5">
                            <option>No Supervision</option>
                            <option>1:1 Meeting (with Supervisor)</option>
                            <option>Group Supervision</option>
                            <option>Observation with Client (by Supervisor)</option>
                        </select></div>
                    <div id="edit-supervisor-name-wrapper"><label for="edit-supervisor-select"
                            class="block mb-2 text-sm">Overseeing Supervisor</label><select id="edit-supervisor-select"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5" required></select>
                    </div>
                    <div><label for="edit-client-present" class="block mb-2 text-sm">Client Present?</label><select
                            id="edit-client-present"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5">
                            <option>No</option>
                            <option>Yes</option>
                        </select></div>

                    <!-- Client Name / Student ID: Always visible -->
                    <div id="edit-client-name-wrapper"><label class="block mb-2 text-sm">Client Name / Student
                            ID</label><input type="text" id="edit-client-name"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5" required></div>

                    <div id="edit-unrestricted-type-wrapper" class="hidden md:col-span-2"><label
                            class="block mb-2 text-sm">Unrestricted Activity</label><select
                            id="edit-unrestricted-type-select"
                            class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5">
                            <option value="">Select Activity...</option>
                            <option>Observation</option>
                            <option>Training</option>
                            <option>Assessments</option>
                            <option>Graphing/Analysis</option>
                            <option>Research</option>
                            <option>Writing Programs/Reports</option>
                        </select></div>
                    <div id="edit-unrestricted-wrapper" class="hidden md:col-span-2"><label
                            class="block mb-2 text-sm">Unrestricted Explanation</label><textarea
                            id="edit-unrestricted-explanation" rows="2"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5"></textarea></div>
                    <div class="md:col-span-2"><label class="block mb-2 text-sm">Additional Notes
                            (Required)</label><textarea id="edit-notes" rows="3"
                            class="bg-gray-500 border-gray-500 text-text rounded-lg w-full p-2.5" required></textarea>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button type="submit"
                        class="w-full text-white bg-button hover:bg-button-hover rounded-lg text-sm px-5 py-2.5">Save
                        Changes</button>
                    <button type="button" id="delete-button"
                        class="w-full text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm px-5 py-2.5">Delete</button>
                    <button type="button" id="cancel-edit"
                        class="w-full text-gray-300 bg-gray-500 hover:bg-gray-600 rounded-lg text-sm px-5 py-2.5">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel"
        class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-700 shadow-lg p-6 transform translate-x-full z-50 overflow-y-auto settings-panel">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-text">Settings</h2>
            <button id="close-settings-btn" class="text-gray-400 hover:text-text text-3xl">&times;</button>
        </div>
        <form id="profile-form">
            <div class="mb-4">
                <label for="trainee-name" class="block mb-2 text-sm font-medium text-gray-300">Your Name</label>
                <input type="text" id="trainee-name"
                    class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                    placeholder="e.g., Jane Doe">
            </div>
            <div class="mb-6">
                <label for="rbt-number" class="block mb-2 text-sm font-medium text-gray-300">RBT Number / BACB
                    ID</label>
                <input type="text" id="rbt-number"
                    class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"
                    placeholder="e.g., RBT-123456">
            </div>
            <!-- API Key Field REMOVED -->
            <button type="submit"
                class="w-full text-white bg-button hover:bg-button-hover font-medium rounded-lg text-sm px-5 py-2.5 mb-6">Save
                Profile</button>
        </form>
        <hr class="border-gray-500 my-6">
        <div>
            <h3 class="text-xl font-semibold text-text mb-4">Manage Supervisors</h3>
            <form id="supervisor-form" class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label for="supervisor-name-input" class="block mb-2 text-sm font-medium text-gray-300">Supervisor
                        Name</label>
                    <input type="text" id="supervisor-name-input"
                        class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5" required>
                </div>
                <div>
                    <label for="supervisor-cert-input"
                        class="block mb-2 text-sm font-medium text-gray-300">Certification #</label>
                    <input type="text" id="supervisor-cert-input"
                        class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5" required>
                </div>
                <button type="submit"
                    class="w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5">Add
                    Supervisor</button>
            </form>
            <div id="supervisors-list"></div>
        </div>
    </div>

    <!-- MFVF Supervisor Selection Modal -->
    <div id="mfvf-modal"
        class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-4 z-50 hidden opacity-0">
        <div
            class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-transform duration-300 scale-95">
            <h2 class="text-2xl font-semibold text-text mb-4">Generate M-FVF</h2>
            <p class="text-gray-300 mb-4 text-sm">Please select the supervisor for whom you are generating this monthly
                form.</p>
            <div>
                <label for="mfvf-supervisor-select" class="block mb-2 text-sm font-medium">Supervisor</label>
                <select id="mfvf-supervisor-select"
                    class="bg-gray-500 border border-gray-500 text-text text-sm rounded-lg w-full p-2.5"></select>
            </div>
            <div class="mt-6 flex gap-3">
                <button id="mfvf-generate-confirm"
                    class="w-full text-white bg-button hover:bg-button-hover rounded-lg text-sm px-5 py-2.5">Generate</button>
                <button id="mfvf-cancel"
                    class="w-full text-gray-300 bg-gray-500 hover:bg-gray-600 rounded-lg text-sm px-5 py-2.5">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col p-4 z-50 hidden opacity-0">
        <div class="bg-gray-700 rounded-lg p-4 flex-shrink-0 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-text">PDF Preview</h2>
            <div class="flex gap-4">
                <button id="pdf-download-btn"
                    class="w-full text-white bg-button hover:bg-button-hover rounded-lg text-sm px-5 py-2.5">Download</button>
                <button id="pdf-close-btn"
                    class="w-full text-gray-300 bg-gray-500 hover:bg-gray-600 rounded-lg text-sm px-5 py-2.5">Close</button>
            </div>
        </div>
        <iframe id="pdf-iframe" class="w-full h-full bg-white rounded-b-lg flex-grow"></iframe>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Config & State ---
        const firebaseConfig = {
            apiKey: "AIzaSyAl4i1nP24SOvAt1ifbGD0SZo2u_l4MnB8",
            authDomain: "fieldwork-tracker-ae8f7.firebaseapp.com",
            projectId: "fieldwork-tracker-ae8f7",
            storageBucket: "fieldwork-tracker-ae8f7.firebasestorage.app",
            messagingSenderId: "4649951899",
            appId: "1:4649951899:web:28278ddb278baf67b39c3e"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fieldwork-tracker-default';
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        const { jsPDF } = window.jspdf;

        let db, auth;
        let userId = null; // Can be Google UID or 'guest'
        let allEntries = [];
        let profileData = { name: '', rbtNumber: '', supervisors: [] };
        let unsubscribeEntries = null;
        let unsubscribeProfile = null;
        let chartInstances = {};
        let currentPdfDoc = null;
        let currentPdfFilename = "report.pdf";

        // Define all logic functions BEFORE DOMContentLoaded
        const calculateHours = (start, end) => {
            if (!start || !end) return 0;
            const startTime = dayjs(`1970-01-01T${start}`);
            let endTime = dayjs(`1970-01-01T${end}`);
            if (endTime.isBefore(startTime)) endTime = endTime.add(1, 'day');
            return endTime.diff(startTime, 'hour', true);
        };

        const calculateSummaryData = (entries) => {
            let total = 0, supervised = 0, restricted = 0, unrestricted = 0, contacts = 0;
            entries.forEach(entry => {
                const hours = calculateHours(entry.startTime, entry.endTime);
                total += hours;
                if (entry.activityType === 'Restricted') restricted += hours;
                else unrestricted += hours;
                if (entry.supervisionType !== 'No Supervision') { supervised += hours; contacts++; }
            });
            const percentage = total > 0 ? (supervised / total) * 100 : 0;
            return { restricted, unrestricted, total, supervised, percentage, contacts };
        };

        // Initialize app after DOM content loads
        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // All element getters
            const loginView = document.getElementById('login-view');
            const loginErrorMessage = document.getElementById('login-error-message');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');
            const viewBtns = document.querySelectorAll('.view-btn');
            const views = document.querySelectorAll('.view-container');
            const monthSelector = document.getElementById('month-selector');
            const yearSelector = document.getElementById('year-selector');
            const trackerForm = document.getElementById('tracker-form');
            const activityTypeSelect = document.getElementById('activity-type');
            const unrestrictedWrapper = document.getElementById('unrestricted-wrapper');
            const supervisionTypeSelect = document.getElementById('supervision-type');
            const supervisorNameWrapper = document.getElementById('supervisor-name-wrapper');
            const supervisorSelect = document.getElementById('supervisor-select');
            const clientPresentSelect = document.getElementById('client-present');
            const clientNameWrapper = document.getElementById('client-name-wrapper');
            const settingSelect = document.getElementById('setting');
            const unrestrictedTypeWrapper = document.getElementById('unrestricted-type-wrapper');
            const unrestrictedTypeSelect = document.getElementById('unrestricted-type-select');
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const notesField = document.getElementById('notes');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const deleteBtn = document.getElementById('delete-button');
            const editActivityTypeSelect = document.getElementById('edit-activity-type');
            const editUnrestrictedWrapper = document.getElementById('edit-unrestricted-wrapper');
            const editSupervisionTypeSelect = document.getElementById('edit-supervision-type');
            const editSupervisorNameWrapper = document.getElementById('edit-supervisor-name-wrapper');
            const editSupervisorSelect = document.getElementById('edit-supervisor-select');
            const editClientPresentSelect = document.getElementById('edit-client-present');
            const editClientNameWrapper = document.getElementById('edit-client-name-wrapper');
            const editSettingSelect = document.getElementById('edit-setting');
            const editUnrestrictedTypeWrapper = document.getElementById('edit-unrestricted-type-wrapper');
            const editUnrestrictedTypeSelect = document.getElementById('edit-unrestricted-type-select');
            const settingsPanel = document.getElementById('settings-panel');
            const settingsBtn = document.getElementById('settings-btn');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const profileForm = document.getElementById('profile-form');
            const supervisorForm = document.getElementById('supervisor-form');
            const supervisorsList = document.getElementById('supervisors-list');
            const generateMfvfBtn = document.getElementById('generate-mfvf-btn');
            const exportMonthlyCsvBtn = document.getElementById('export-monthly-csv-btn');
            const exportYearlyPdfBtn = document.getElementById('export-yearly-pdf-btn');
            const exportYearlyCsvBtn = document.getElementById('export-yearly-csv-btn');
            const exportAllTimePdfBtn = document.getElementById('export-all-time-pdf-btn');
            const exportAllTimeCsvBtn = document.getElementById('export-all-time-csv-btn');
            const mfvfModal = document.getElementById('mfvf-modal');
            const mfvfSupervisorSelect = document.getElementById('mfvf-supervisor-select');
            const mfvfGenerateConfirm = document.getElementById('mfvf-generate-confirm');
            const mfvfCancel = document.getElementById('mfvf-cancel');
            const pdfPreviewModal = document.getElementById('pdf-preview-modal');
            const pdfIframe = document.getElementById('pdf-iframe');
            const pdfDownloadBtn = document.getElementById('pdf-download-btn');
            const pdfCloseBtn = document.getElementById('pdf-close-btn');
            // const apiKeyInput = document.getElementById('gemini-api-key'); // Removed from DOM

            // Define functions using DOM elements inside DOMContentLoaded
            const toggleFieldVisibility = (select, wrapper, conditionValue) => {
                const conditionMet = Array.isArray(conditionValue) ? conditionValue.includes(select.value) : select.value === conditionValue;
                if (conditionMet) wrapper.classList.remove('hidden');
                else wrapper.classList.add('hidden');
            };
            const toggleUnrestrictedActivityVisibility = () => {
                if (activityTypeSelect.value === 'Unrestricted') {
                    unrestrictedTypeWrapper.classList.remove('hidden');
                } else {
                    unrestrictedTypeWrapper.classList.add('hidden');
                    unrestrictedTypeSelect.value = '';
                }
            };
            const toggleEditUnrestrictedActivityVisibility = () => {
                if (editActivityTypeSelect.value === 'Unrestricted') {
                    editUnrestrictedTypeWrapper.classList.remove('hidden');
                } else {
                    editUnrestrictedTypeWrapper.classList.add('hidden');
                    editUnrestrictedTypeSelect.value = '';
                }
            };

            const createSummaryHTML = (data) => `
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Restricted Hours</h3><p class="text-2xl font-bold text-accent2">${data.restricted.toFixed(2)}</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Unrestricted Hours</h3><p class="text-2xl font-bold text-purple-400">${data.unrestricted.toFixed(2)}</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Total Hours</h3><p class="text-2xl font-bold text-text">${data.total.toFixed(2)}</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Supervised Hours</h3><p class="text-2xl font-bold text-accent1">${data.supervised.toFixed(2)}</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Supervisor Contacts</h3><p class="text-2xl font-bold text-text">${data.contacts}</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Supervision %</h3><p class="text-2xl font-bold text-black rounded-md px-2 ${data.percentage < 8 ? 'percentage-red' : data.percentage < 10 ? 'percentage-yellow' : 'percentage-green'}">${data.percentage.toFixed(2)}%</p></div>
                <div class="summary-box"><h3 class="text-sm font-medium text-gray-300">Hours Remaining</h3><p class="text-2xl font-bold text-text">${Math.max(0, 1500 - data.total).toFixed(2)}</p></div>
            `;

            const renderTable = (entries, tableBodyElement) => {
                tableBodyElement.innerHTML = '';
                if (entries.length === 0) {
                    tableBodyElement.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-gray-400">No activities logged for this period.</td></tr>`;
                    return;
                }
                const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedEntries.forEach(entry => {
                    const totalHours = calculateHours(entry.startTime, entry.endTime);
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-600 border-b border-gray-700 hover:bg-gray-500';
                    let notesDisplay = entry.notes || '';
                    if (entry.unrestrictedActivityType) notesDisplay = `[${entry.unrestrictedActivityType}] ${entry.unrestrictedExplanation || notesDisplay}`;
                    else if (entry.unrestrictedExplanation) notesDisplay = entry.unrestrictedExplanation;
                    row.innerHTML = `
                        <td class="px-4 py-3">${dayjs(entry.date).format('MM/DD/YYYY')}</td>
                        <td class="px-4 py-3">${dayjs('1970-01-01T' + entry.startTime).format('h:mm A')}</td>
                        <td class="px-4 py-3">${dayjs('1970-01-01T' + entry.endTime).format('h:mm A')}</td>
                        <td class="px-4 py-3">${totalHours.toFixed(2)}</td>
                        <td class="px-4 py-3">${entry.setting || 'N/A'}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 font-semibold leading-tight ${entry.activityType === 'Unrestricted' ? 'text-purple-200 bg-purple-900/60' : 'text-accent2 bg-pink-900/50'} rounded-full text-xs">${entry.activityType}</span></td>
                        <td class="px-4 py-3">${entry.supervisionType}</td>
                        <td class="px-4 py-3">${entry.supervisorName || 'N/A'}</td>
                        <td class="px-4 py-3">${entry.clientName || 'N/A'}</td>
                        <td class="px-4 py-3 text-gray-300 hidden md:table-cell max-w-xs truncate" title="${notesDisplay}">${notesDisplay}</td>
                        <td class="px-4 py-3 text-right"><button class="edit-btn font-medium text-accent1 hover:underline mr-3" data-id="${entry.id}">Edit</button><button class="copy-btn font-medium text-amber-400 hover:underline" data-id="${entry.id}">Copy</button></td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            };

            const renderAllTimeCharts = (entries) => {
                Object.values(chartInstances).forEach(chart => chart.destroy());
                if (entries.length === 0) return;
                const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
                const startDate = dayjs(sortedEntries[0].date).startOf('month');
                const today = dayjs().startOf('month');
                let monthSpan = today.diff(startDate, 'month') + 1;
                monthSpan = Math.max(1, monthSpan);
                const totalMonths = Math.min(monthSpan, 36);
                const labels = [];
                for (let i = 0; i < totalMonths; i++) labels.push(startDate.add(i, 'month').format('MMM YYYY'));
                let dataTotal = new Array(totalMonths).fill(0), dataRestricted = new Array(totalMonths).fill(0), dataUnrestricted = new Array(totalMonths).fill(0);
                entries.forEach(entry => {
                    const entryDate = dayjs(entry.date);
                    const monthIndex = entryDate.diff(startDate, 'month');
                    if (monthIndex < 0 || monthIndex >= totalMonths) return;
                    const hours = calculateHours(entry.startTime, entry.endTime);
                    dataTotal[monthIndex] += hours;
                    if (entry.activityType === 'Restricted') dataRestricted[monthIndex] += hours;
                    else dataUnrestricted[monthIndex] += hours;
                });
                for (let i = 1; i < totalMonths; i++) {
                    dataTotal[i] += dataTotal[i - 1];
                    dataRestricted[i] += dataRestricted[i - 1];
                    dataUnrestricted[i] += dataUnrestricted[i - 1];
                }
                const chartConfig = (label, data, goal, color) => ({
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: label, data: data, borderColor: color, backgroundColor: `${color}1A`, fill: true, tension: 0.1 }] },
                    options: {
                        scales: { y: { beginAtZero: true, suggestedMax: goal, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                        plugins: { legend: { display: false } }
                    }
                });
                chartInstances.total = new Chart(document.getElementById('totalHoursChart').getContext('2d'), chartConfig('Total Hours', dataTotal, 1500, '#A8DADC'));
                chartInstances.restricted = new Chart(document.getElementById('restrictedHoursChart').getContext('2d'), chartConfig('Restricted Hours', dataRestricted, 600, '#FFC1CC'));
                chartInstances.unrestricted = new Chart(document.getElementById('unrestrictedHoursChart').getContext('2d'), chartConfig('Unrestricted Hours', dataUnrestricted, 900, '#c084fc'));
            };

            const updateMonthlyView = () => {
                const selectedMonth = monthSelector.value; if (!selectedMonth) return;
                const [year, month] = selectedMonth.split('-');
                const monthlyEntries = allEntries.filter(e => { const d = dayjs(e.date); return d.year() == year && (d.month() + 1) == month; });
                document.getElementById('monthly-summary-grid').innerHTML = createSummaryHTML(calculateSummaryData(monthlyEntries));
                renderTable(monthlyEntries, logTableBody);
            };
            const updateYearlyView = () => {
                const selectedYear = yearSelector.value; if (!selectedYear) return;
                const yearlyEntries = allEntries.filter(e => dayjs(e.date).year() == selectedYear);
                document.getElementById('yearly-summary-grid').innerHTML = createSummaryHTML(calculateSummaryData(yearlyEntries));
                renderTable(yearlyEntries, yearlyLogTableBody);
            };
            const updateAllTimeView = () => {
                const summary = calculateSummaryData(allEntries);
                document.getElementById('all-time-summary-grid').innerHTML = createSummaryHTML(summary);
                renderTable(allEntries, allTimeLogTableBody);
                renderAllTimeCharts(allEntries);
            };

            const switchView = (viewId) => {
                views.forEach(view => view.classList.add('hidden'));
                document.getElementById(`${viewId}-view`).classList.remove('hidden');
                viewBtns.forEach(btn => { btn.classList.toggle('view-btn-active', btn.dataset.view === viewId); btn.classList.toggle('view-btn', btn.dataset.view !== viewId); });
                if (viewId === 'monthly') updateMonthlyView();
                else if (viewId === 'yearly') updateYearlyView();
                else if (viewId === 'all-time') updateAllTimeView();
            };

            const renderSupervisors = () => {
                supervisorsList.innerHTML = '';
                const supervisorDropdowns = [supervisorSelect, editSupervisorSelect, mfvfSupervisorSelect];
                supervisorDropdowns.forEach(sel => sel.innerHTML = '<option value="">Select a supervisor...</option>');
                if (profileData.supervisors) {
                    profileData.supervisors.forEach(s => {
                        const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-gray-500 p-2 rounded-lg mb-2';
                        div.innerHTML = `<span>${s.name} (${s.cert})</span><button class="remove-supervisor-btn text-red-500 font-bold" data-name="${s.name}">&times;</button>`;
                        supervisorsList.appendChild(div);
                        supervisorDropdowns.forEach(sel => sel.add(new Option(`${s.name}`, s.name)));
                    });
                }
            };

            const addSupervisor = async (e) => {
                e.preventDefault(); const addBtn = supervisorForm.querySelector('button[type="submit"]'); addBtn.disabled = true;
                const name = document.getElementById('supervisor-name-input').value; const cert = document.getElementById('supervisor-cert-input').value;
                if (!profileData.supervisors) profileData.supervisors = [];
                if (name && cert && !profileData.supervisors.find(s => s.name === name)) {
                    profileData.supervisors.push({ name, cert });
                    if (userId === 'guest') { saveProfileToLocalStorage(); renderSupervisors(); supervisorForm.reset(); }
                    else { try { await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/data`), { supervisors: profileData.supervisors }, { merge: true }); supervisorForm.reset(); } catch (error) { profileData.supervisors.pop(); } }
                }
                addBtn.disabled = false;
            };

            const removeSupervisor = async (name) => {
                profileData.supervisors = profileData.supervisors.filter(s => s.name !== name);
                if (userId === 'guest') { saveProfileToLocalStorage(); renderSupervisors(); }
                else { await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/data`), { supervisors: profileData.supervisors }, { merge: true }); }
            };

            const loadDataFromLocalStorage = () => {
                allEntries = JSON.parse(localStorage.getItem('fieldwork_entries')) || [];
                profileData = JSON.parse(localStorage.getItem('fieldwork_profile')) || { name: 'Guest User', rbtNumber: '', supervisors: [] };
                document.getElementById('trainee-name').value = profileData.name; document.getElementById('rbt-number').value = profileData.rbtNumber; renderSupervisors();
            };

            const saveEntriesToLocalStorage = () => localStorage.setItem('fieldwork_entries', JSON.stringify(allEntries));
            const saveProfileToLocalStorage = () => localStorage.setItem('fieldwork_profile', JSON.stringify(profileData));

            const handleGuestLogin = () => {
                userId = 'guest';
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userDisplay.textContent = 'Guest (Temporary)';
                loadDataFromLocalStorage();
                switchView('monthly');
            };
            const handleLogout = async () => {
                if (userId === 'guest') { userId = null; appContainer.classList.add('hidden'); loginView.classList.remove('hidden'); allEntries = []; profileData = { name: '', rbtNumber: '', supervisors: [] }; }
                else { try { await signOut(auth); } catch (error) { console.error("Sign-out error", error); } }
            };
            const handleGoogleLogin = async () => {
                loginErrorMessage.classList.add('hidden'); const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (error) { console.error("Google sign-in error", error); if (error.code === 'auth/unauthorized-domain') loginErrorMessage.innerHTML = `<strong>Login Failed:</strong> Domain not authorized.`; else loginErrorMessage.textContent = `Login error: ${error.message}`; loginErrorMessage.classList.remove('hidden'); }
            };

            const showPdfPreview = (doc, filename) => {
                currentPdfDoc = doc; currentPdfFilename = filename; const dataUri = doc.output('datauristring'); pdfIframe.src = dataUri; pdfPreviewModal.classList.remove('hidden'); setTimeout(() => pdfPreviewModal.classList.remove('opacity-0'), 10);
            };
            const closePdfPreview = () => { pdfPreviewModal.classList.add('opacity-0'); setTimeout(() => { pdfPreviewModal.classList.add('hidden'); pdfIframe.src = ''; }, 300); };
            const downloadPdf = () => { if (currentPdfDoc) currentPdfDoc.save(currentPdfFilename); };

            const exportToCsv = (entries, summaryData, filename) => {
                const headers = ["Date", "Start Time", "End Time", "Hours", "Setting", "Activity Type", "Supervision Type", "Unrestricted Activity", "Supervisor", "Client", "Notes"];
                let csvContent = headers.join(",") + "\n";
                const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedEntries.forEach(entry => {
                    const hours = calculateHours(entry.startTime, entry.endTime).toFixed(2);
                    const row = [
                        entry.date, entry.startTime, entry.endTime, hours, entry.setting || '', entry.activityType, entry.supervisionType,
                        entry.unrestrictedActivityType || '', entry.supervisorName || '', entry.clientName || '', `"${(entry.notes || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });
                csvContent += `\n\nSummary\nTotal Hours,${summaryData.total.toFixed(2)}\nRestricted Hours,${summaryData.restricted.toFixed(2)}\nUnrestricted Hours,${summaryData.unrestricted.toFixed(2)}\n`;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.click();
            };

            const generatePdf = (title, entries, orientation = 'landscape') => {
                const doc = new jsPDF({ orientation: orientation });
                const summary = calculateSummaryData(entries);
                doc.setFontSize(18); doc.setTextColor('#B39CD0'); doc.text(title, 14, 22);
                doc.setFontSize(11); doc.setTextColor(50, 50, 50);
                doc.text(`Trainee: ${profileData.name || 'N/A'}`, 14, 32);
                doc.text(`Summary: Total: ${summary.total.toFixed(2)}hrs | Supervised: ${summary.supervised.toFixed(2)}hrs (${summary.percentage.toFixed(2)}%)`, 14, 38);
                const tableColumn = ["Date", "Time", "Hours", "Setting", "Type", "Supervision", "Supervisor", "Client", "Notes"];
                const tableRows = [];
                entries.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(entry => {
                    tableRows.push([
                        dayjs(entry.date).format('MM/DD/YYYY'),
                        `${dayjs('1970-01-01T' + entry.startTime).format('h:mm A')} - ${dayjs('1970-01-01T' + entry.endTime).format('h:mm A')}`,
                        calculateHours(entry.startTime, entry.endTime).toFixed(2),
                        entry.setting || 'N/A', entry.activityType, entry.supervisionType, entry.supervisorName || 'N/A', entry.clientName || 'N/A', entry.notes || ''
                    ]);
                });
                doc.autoTable(tableColumn, tableRows, { startY: 50, styles: { fontSize: 8 }, headStyles: { fillColor: '#A8DADC', textColor: '#2C2C2C' } });
                showPdfPreview(doc, `${title.replace(/ /g, '_')}.pdf`);
            };

            const handleAddEntry = async (e) => {
                e.preventDefault();
                const newEntry = {
                    date: trackerForm.elements.date.value, startTime: trackerForm.elements['start-time'].value, endTime: trackerForm.elements['end-time'].value,
                    setting: trackerForm.elements.setting.value, activityType: trackerForm.elements['activity-type'].value,
                    unrestrictedExplanation: trackerForm.elements['unrestricted-explanation'].value, unrestrictedActivityType: trackerForm.elements['unrestricted-type-select'].value,
                    supervisionType: trackerForm.elements['supervision-type'].value, supervisorName: trackerForm.elements['supervisor-select'].value,
                    clientPresent: trackerForm.elements['client-present'].value, clientName: trackerForm.elements['client-name'].value, notes: trackerForm.elements.notes.value,
                };
                if (userId === 'guest') { newEntry.id = crypto.randomUUID(); allEntries.push(newEntry); saveEntriesToLocalStorage(); updateMonthlyView(); }
                else { newEntry.userId = userId; try { await addDoc(collection(db, `artifacts/${appId}/users/${userId}/fieldwork_entries`), newEntry); } catch (error) { console.error("Error adding document:", error); } }
                trackerForm.reset(); toggleFieldVisibility(activityTypeSelect, unrestrictedWrapper, 'Unrestricted'); toggleUnrestrictedActivityVisibility(); trackerForm.elements.date.value = dayjs().format('YYYY-MM-DD');
            };

            const handleUpdateEntry = async (e) => {
                e.preventDefault();
                const entryId = editForm.elements['edit-id'].value;
                const updatedEntryData = {
                    date: editForm.elements['edit-date'].value, startTime: editForm.elements['edit-start-time'].value, endTime: editForm.elements['edit-end-time'].value,
                    setting: editForm.elements['edit-setting'].value, activityType: editForm.elements['edit-activity-type'].value,
                    unrestrictedExplanation: editForm.elements['edit-unrestricted-explanation'].value, unrestrictedActivityType: editForm.elements['edit-unrestricted-type-select'].value,
                    supervisionType: editForm.elements['edit-supervision-type'].value, supervisorName: editForm.elements['edit-supervisor-select'].value,
                    clientPresent: editForm.elements['edit-client-present'].value, clientName: editForm.elements['edit-client-name'].value, notes: editForm.elements['edit-notes'].value,
                };
                if (userId === 'guest') { const index = allEntries.findIndex(e => e.id === entryId); if (index > -1) { allEntries[index] = { ...allEntries[index], ...updatedEntryData }; saveEntriesToLocalStorage(); switchView(document.querySelector('.view-btn-active').dataset.view); } }
                else { try { await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/fieldwork_entries`, entryId), updatedEntryData); } catch (error) { console.error("Error updating doc:", error); } }
                closeEditModal();
            };

            const handleDeleteEntry = async () => {
                const entryId = editForm.elements['edit-id'].value; if (!confirm("Delete entry?")) return;
                if (userId === 'guest') { allEntries = allEntries.filter(e => e.id !== entryId); saveEntriesToLocalStorage(); switchView(document.querySelector('.view-btn-active').dataset.view); }
                else { try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/fieldwork_entries`, entryId)); } catch (error) { console.error("Error deleting:", error); } }
                closeEditModal();
            };

            const handleTableClick = (e) => {
                const entryId = e.target.dataset.id; if (!entryId) return; const entry = allEntries.find(item => item.id === entryId); if (!entry) return;
                if (e.target.classList.contains('edit-btn')) openEditModal(entry); else if (e.target.classList.contains('copy-btn')) copyEntryToForm(entry);
            };
            const copyEntryToForm = (entry) => {
                trackerForm.elements.date.value = entry.date; trackerForm.elements['start-time'].value = entry.startTime; trackerForm.elements['end-time'].value = entry.endTime;
                trackerForm.elements.setting.value = entry.setting || 'School'; trackerForm.elements['activity-type'].value = entry.activityType;
                trackerForm.elements['unrestricted-explanation'].value = entry.unrestrictedExplanation || ''; trackerForm.elements['unrestricted-type-select'].value = entry.unrestrictedActivityType || '';
                trackerForm.elements['supervision-type'].value = entry.supervisionType; trackerForm.elements['supervisor-select'].value = entry.supervisorName || '';
                trackerForm.elements['client-present'].value = entry.clientPresent; trackerForm.elements['client-name'].value = entry.clientName || ''; trackerForm.elements.notes.value = entry.notes || '';
                toggleFieldVisibility(activityTypeSelect, unrestrictedWrapper, 'Unrestricted'); toggleUnrestrictedActivityVisibility(); window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const openEditModal = (entry) => {
                editForm.elements['edit-id'].value = entry.id; editForm.elements['edit-date'].value = entry.date; editForm.elements['edit-start-time'].value = entry.startTime; editForm.elements['edit-end-time'].value = entry.endTime;
                editForm.elements['edit-setting'].value = entry.setting || 'School'; editForm.elements['edit-activity-type'].value = entry.activityType;
                editForm.elements['edit-unrestricted-explanation'].value = entry.unrestrictedExplanation || ''; editForm.elements['edit-unrestricted-type-select'].value = entry.unrestrictedActivityType || '';
                editForm.elements['edit-supervision-type'].value = entry.supervisionType; editForm.elements['edit-supervisor-select'].value = entry.supervisorName || '';
                editForm.elements['edit-client-present'].value = entry.clientPresent; editForm.elements['edit-client-name'].value = entry.clientName || ''; editForm.elements['edit-notes'].value = entry.notes || '';

                toggleFieldVisibility(editActivityTypeSelect, editUnrestrictedWrapper, 'Unrestricted'); toggleEditUnrestrictedActivityVisibility();
                editModal.classList.remove('hidden'); setTimeout(() => { editModal.classList.remove('opacity-0'); editModal.querySelector('div').classList.remove('scale-95'); }, 10);
            };
            const closeEditModal = () => { editModal.classList.add('opacity-0'); editModal.querySelector('div').classList.add('scale-95'); setTimeout(() => editModal.classList.add('hidden'), 300); };

            const saveProfile = async (e) => {
                e.preventDefault(); const saveBtn = profileForm.querySelector('button[type="submit"]'); saveBtn.textContent = 'Saving...'; saveBtn.disabled = true;
                const name = document.getElementById('trainee-name').value; const rbtNumber = document.getElementById('rbt-number').value;
                profileData.name = name; profileData.rbtNumber = rbtNumber;
                if (userId === 'guest') { saveProfileToLocalStorage(); saveBtn.textContent = 'Saved!'; }
                else { try { await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/data`), { name, rbtNumber }, { merge: true }); saveBtn.textContent = 'Saved!'; } catch (error) { saveBtn.textContent = 'Error!'; } }
                setTimeout(() => { saveBtn.textContent = 'Save Profile'; saveBtn.disabled = false; }, 2000);
            };

            // Listeners
            loginBtn.addEventListener('click', handleGoogleLogin); guestLoginBtn.addEventListener('click', handleGuestLogin); logoutBtn.addEventListener('click', handleLogout);
            viewBtns.forEach(btn => btn.addEventListener('click', (e) => switchView(e.target.dataset.view)));
            monthSelector.addEventListener('change', updateMonthlyView); yearSelector.addEventListener('change', updateYearlyView);
            trackerForm.addEventListener('submit', handleAddEntry); logTableBody.addEventListener('click', handleTableClick);
            yearlyLogTableBody.addEventListener('click', handleTableClick); allTimeLogTableBody.addEventListener('click', handleTableClick);
            editForm.addEventListener('submit', handleUpdateEntry); deleteBtn.addEventListener('click', handleDeleteEntry); cancelEditBtn.addEventListener('click', closeEditModal);
            settingsBtn.addEventListener('click', openSettings); closeSettingsBtn.addEventListener('click', closeSettings);
            profileForm.addEventListener('submit', saveProfile); supervisorForm.addEventListener('submit', addSupervisor);
            supervisorsList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-supervisor-btn')) removeSupervisor(e.target.dataset.name); });
            // aiGenerateBtn.addEventListener('click', generateNoteWithAI);
            activityTypeSelect.addEventListener('change', () => { toggleFieldVisibility(activityTypeSelect, unrestrictedWrapper, 'Unrestricted'); toggleUnrestrictedActivityVisibility(); });
            supervisionTypeSelect.addEventListener('change', () => { toggleUnrestrictedActivityVisibility(); });
            editActivityTypeSelect.addEventListener('change', () => { toggleFieldVisibility(editActivityTypeSelect, editUnrestrictedWrapper, 'Unrestricted'); toggleEditUnrestrictedActivityVisibility(); });
            editSupervisionTypeSelect.addEventListener('change', () => { toggleEditUnrestrictedActivityVisibility(); });
            generateMfvfBtn.addEventListener('click', generateMfvfPdf); mfvfCancel.addEventListener('click', () => { mfvfModal.classList.add('opacity-0'); setTimeout(() => mfvfModal.classList.add('hidden'), 300) }); mfvfGenerateConfirm.addEventListener('click', confirmGenerateMfvf);
            exportMonthlyCsvBtn.addEventListener('click', () => { const selectedMonth = monthSelector.value; const [year, month] = selectedMonth.split('-'); const entries = allEntries.filter(e => { const d = dayjs(e.date); return d.year() == year && (d.month() + 1) == month; }); const summary = calculateSummaryData(entries); exportToCsv(entries, summary, `Monthly_Log_${dayjs(selectedMonth).format('MMM_YYYY')}.csv`); });
            exportYearlyPdfBtn.addEventListener('click', () => { const year = yearSelector.value; const entries = allEntries.filter(e => dayjs(e.date).year() == year); generatePdf(`Yearly Report ${year}`, entries, 'landscape'); });
            exportYearlyCsvBtn.addEventListener('click', () => { const year = yearSelector.value; const entries = allEntries.filter(e => dayjs(e.date).year() == year); const summary = calculateSummaryData(entries); exportToCsv(entries, summary, `Yearly_Log_${year}.csv`); });
            exportAllTimePdfBtn.addEventListener('click', () => generatePdf('Full Fieldwork History', allEntries, 'landscape'));
            exportAllTimeCsvBtn.addEventListener('click', () => { const summary = calculateSummaryData(allEntries); exportToCsv(allEntries, summary, 'Full_Fieldwork_History.csv'); });
            pdfCloseBtn.addEventListener('click', closePdfPreview); pdfDownloadBtn.addEventListener('click', downloadPdf);

            onAuthStateChanged(auth, user => {
                if (unsubscribeEntries) unsubscribeEntries();
                if (unsubscribeProfile) unsubscribeProfile();
                if (user && !user.isAnonymous) {
                    userId = user.uid; loginView.classList.add('hidden'); appContainer.classList.remove('hidden'); userDisplay.textContent = user.displayName || user.email;
                    unsubscribeProfile = onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/profile/data`), (doc) => {
                        if (doc.exists()) { const data = doc.data(); profileData = { name: data.name || '', rbtNumber: data.rbtNumber || '', supervisors: data.supervisors || [] }; }
                        else profileData = { name: auth.currentUser.displayName, rbtNumber: '', supervisors: [] };
                        document.getElementById('trainee-name').value = profileData.name; document.getElementById('rbt-number').value = profileData.rbtNumber; renderSupervisors();
                    });
                    unsubscribeEntries = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/fieldwork_entries`), snapshot => {
                        allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); switchView(document.querySelector('.view-btn-active').dataset.view);
                    });
                    switchView('monthly');
                } else if (userId !== 'guest') {
                    userId = null; appContainer.classList.add('hidden'); loginView.classList.remove('hidden'); allEntries = [];
                }
            });

            monthSelector.value = dayjs().format('YYYY-MM'); yearSelector.value = dayjs().year(); trackerForm.elements.date.value = dayjs().format('YYYY-MM-DD'); switchView('monthly');
        });
    </script>
</body>

</html>